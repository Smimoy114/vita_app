from nicegui import ui
from controllers.productos_ctr import ProductoController # Importamos el controlador

# Inicializamos el controlador
controller = ProductoController()

columns = [
    {'name': 'codigo', 'label': 'Código', 'field': 'codigo', 'required': True, 'align': 'left'},
    {'name': 'nombre', 'label': 'Nombre', 'field': 'nombre', 'align': 'left'},
    {'name': 'precio', 'label': 'Precio ($)', 'field': 'precio', 'align': 'right'},
    {'name': 'descripcion', 'label': 'Descripción', 'field': 'descripcion', 'align': 'left'},
    {'name': 'formato', 'label': 'Formato', 'align': 'left', 'field': 'formato'},
]

def render_productos(container):
    """Renderiza el panel completo de gestión de productos."""
    container.clear()
    with container:
        ui.label('Gestión de Productos').classes('text-h4 mb-4')

        # --- SECCIÓN 1: AGREGAR PRODUCTOS (Formulario) ---
        with ui.card().classes('w-full max-w-lg mb-6'):
            with ui.expansion().classes('w-full') as expansion:
                with expansion.add_slot('header'):
                    with ui.row().classes('items-center justify-between w-full'):
                        ui.label('Añadir Nuevo Producto').classes('text-lg font-semibold')
                        ui.icon('add').classes('text-3xl').bind_if('remove', expansion.bind_opened('value')) # .classes('text-3xl') hace que el icono sea muy grande 

            #with ui.expansion('Añadir Nuevo Producto').classes('w-full').props('expand-icon-class="text-2xl"'):
            #ui.label('Añadir Nuevo Producto').classes('text-lg font-bold')
            with ui.column().classes('w-full p-4'):
                            codigo_input = ui.number('Código', value=None, format='%.0f').props('clearable full-width')
                            nombre_input = ui.input('Nombre').props('clearable full-width')
                            precio_input = ui.number('Precio', value=None).props('suffix="$" clearable full-width')
                            descripcion_input = ui.textarea('Descripción').props('clearable full-width')
                            formato_input = ui.input('Formato').props('clearable full-width')

                            def add_product_action():
               
                                try:
                                    data = {
                                        'codigo': codigo_input.value,
                                        'nombre': nombre_input.value,
                                        'precio': precio_input.value or 0,
                                        'descripcion': descripcion_input.value or '',
                                        'formato': formato_input.value or '',
                                    }
                        
                                    controller.guardar_nuevo_producto(data) 
                    
                    # Recargar datos en la tabla desde la BD
                                    products_table.rows = controller.listar_productos_para_ui()
                                    products_table.update()
                    
                                    ui.notify(f'Producto "{data["nombre"]}" añadido con éxito', type='positive')
                    
                                    # Limpiar campos
                                    codigo_input.value = None
                                    nombre_input.value = None
                                    precio_input.value = None
                                    descripcion_input.value = None
                                    formato_input.value = None
                        
                                except ValueError as e:
                                    ui.notify(f'Error de validación: {e}', type='warning')
                                except Exception as e:
                                    ui.notify(f'Error al guardar: {e}', type='negative')

                            ui.button('Guardar Producto', on_click=add_product_action).classes('mt-4')
                

        # --- SECCIÓN 2: TABLA DE REGISTROS ---
        ui.label('Registros de Productos Existentes').classes('text-lg font-bold mb-2')
        # Cargar datos iniciales desde el controlador
        initial_rows = controller.listar_productos_para_ui()
        products_table = ui.table(columns=columns, rows=initial_rows, row_key='codigo').classes('w-full')
